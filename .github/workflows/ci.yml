name: Mixed Stack CI (Python + TypeScript)

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  test-python:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Detect Python dependencies
        id: detect-py
        run: |
          if [ -f "pyproject.toml" ] || [ -f "requirements.txt" ] || [ -f "setup.py" ]; then
            echo "has-python=true" >> $GITHUB_OUTPUT
          else
            echo "has-python=false" >> $GITHUB_OUTPUT
          fi

      - name: Install Python dependencies
        if: steps.detect-py.outputs.has-python == 'true'
        run: |
          python -m pip install --upgrade pip
          if [ -f "pyproject.toml" ]; then
            pip install -e .[dev] || pip install -e . || true
          elif [ -f "requirements.txt" ]; then
            pip install -r requirements.txt || true
          elif [ -f "setup.py" ]; then
            pip install -e . || true
          fi
          pip install pytest pytest-cov ruff mypy || true

      - name: Lint Python with ruff
        if: steps.detect-py.outputs.has-python == 'true'
        continue-on-error: true
        run: |
          ruff check --output-format=github . || echo "::warning::Ruff found issues"

      - name: Test Python with pytest
        if: steps.detect-py.outputs.has-python == 'true'
        run: |
          if [ -d "tests" ] || [ -d "test" ] || ls test_*.py 2>/dev/null | grep -q .; then
            pytest --cov=. --cov-report=xml --cov-report=term || exit 1
          else
            echo "::notice::No Python tests found"
          fi

      - name: Upload Python coverage
        if: steps.detect-py.outputs.has-python == 'true' && hashFiles('coverage.xml') != ''
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: python

  test-typescript:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Detect Node dependencies
        id: detect-node
        run: |
          if [ -f "package.json" ]; then
            echo "has-node=true" >> $GITHUB_OUTPUT
          else
            echo "has-node=false" >> $GITHUB_OUTPUT
          fi

      - name: Install Node dependencies
        if: steps.detect-node.outputs.has-node == 'true'
        run: npm install || true

      - name: Lint TypeScript
        if: steps.detect-node.outputs.has-node == 'true'
        continue-on-error: true
        run: npm run lint || echo "::warning::ESLint found issues"

      - name: Type check
        if: steps.detect-node.outputs.has-node == 'true' && hashFiles('tsconfig.json') != ''
        continue-on-error: true
        run: npx tsc --noEmit || echo "::warning::Type errors found"

      - name: Test TypeScript
        if: steps.detect-node.outputs.has-node == 'true'
        run: npm test -- --coverage || echo "::notice::No tests configured"

      - name: Upload TypeScript coverage
        if: steps.detect-node.outputs.has-node == 'true' && hashFiles('coverage/lcov.info') != ''
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          flags: typescript
